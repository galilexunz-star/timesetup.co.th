// ==================== CONFIG ====================
const FOLDER_ID = '11yDe62gdamwc8kIfsxibn7z8BHo9lD8K'; // ‚ÄºÔ∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ID ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Google Drive ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const SHEET_NAME = 'Data'; // üìù ‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤
const EMPLOYEE_SHEET_NAME = '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'; // üë• ‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
const LOCATION_SHEET_NAME = '‡∏£‡∏±‡∏®‡∏°‡∏µ'; // üìç ‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏®‡∏°‡∏µ
// ================================================

function doGet() {
  const template = HtmlService.createTemplateFromFile('index');
  return template.evaluate()
    .setTitle("‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô")
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// ================= Location config (support multiple coords) =================
// This getOfficeLocationData reads column B rows 1..lastRow and treats the last non-empty
// cell in column B as the radius (meters). All previous non-empty B cells are treated
// as coordinates in the format "lat,lng". Column A is read as optional labels for each coord.
function getOfficeLocationData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(LOCATION_SHEET_NAME);
  if (!sheet) {
    throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ï '${LOCATION_SHEET_NAME}' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î`);
  }

  const lastRow = sheet.getLastRow();
  if (lastRow < 2) {
    throw new Error(`‡∏ä‡∏µ‡∏ï '${LOCATION_SHEET_NAME}' ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞ 1 ‡πÅ‡∏ñ‡∏ß‡∏£‡∏±‡∏®‡∏°‡∏µ`);
  }

  // Read column B (coords & radius) for rows 1..lastRow
  const colB = sheet.getRange(1, 2, lastRow, 1).getValues().flat();
  // Find last non-empty index in colB (this is treated as radius)
  let lastNonEmptyIndex = -1;
  for (let i = colB.length - 1; i >= 0; i--) {
    const v = colB[i];
    if (v !== null && v !== undefined && String(v).trim() !== '') {
      lastNonEmptyIndex = i;
      break;
    }
  }
  if (lastNonEmptyIndex <= 0) {
    throw new Error(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï '${LOCATION_SHEET_NAME}' ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô B1..B<n-1> ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÉ‡∏ô B<n>)`);
  }

  const radiusVal = colB[lastNonEmptyIndex];
  const radius = Number(radiusVal);
  if (isNaN(radius) || radius <= 0) {
    throw new Error('‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0 (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏°‡∏ï‡∏£)');
  }

  // Collect coordinate strings from B1..B(lastNonEmptyIndex-1)
  const coordStrings = colB.slice(0, lastNonEmptyIndex).map(v => (v === null || v === undefined) ? '' : String(v).trim())
    .filter(s => s !== '');

  if (coordStrings.length === 0) {
    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "lat,lng" ‡∏ó‡∏µ‡πà B1..B(n-1))');
  }

  // Read optional labels from column A for same rows
  const colA = sheet.getRange(1, 1, coordStrings.length, 1).getValues().flat();

  const coords = coordStrings.map((s, idx) => {
    const parts = s.split(',');
    if (parts.length < 2) {
      throw new Error(`‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: '${s}' (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "lat,lng")`);
    }
    const lat = Number(parts[0]);
    const lon = Number(parts[1]);
    if (isNaN(lat) || isNaN(lon)) {
      throw new Error(`‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: '${s}'`);
    }
    const name = (colA[idx] && String(colA[idx]).trim() !== '') ? String(colA[idx]).trim() : '';
    return { name: name, lat: lat, lon: lon };
  });

  return { coords: coords, radius: radius };
}

// getLocationConfig returns a simple object for UI consumption:
// { coords: [{name, lat, lon}, ...], radius: Number }
function getLocationConfig() {
  try {
    const cfg = getOfficeLocationData();
    return {
      coords: cfg.coords,
      radius: cfg.radius
    };
  } catch (e) {
    // If sheet or data missing, return empty structure instead of throwing to UI callers
    return {
      coords: [],
      radius: ''
    };
  }
}

// saveLocationConfig accepts either:
// - coords: array of strings "lat,lng" OR array of objects {name, coords} OR newline-separated string
// - radius: number
// It will write coordinates into column B (and optional names into column A), with the radius in the row after the last coord.
function saveLocationConfig(coords, radius) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(LOCATION_SHEET_NAME);

  if (!sheet) {
    sheet = ss.insertSheet(LOCATION_SHEET_NAME);
  }

  // Normalize coords into array of {name, coordsStr}
  let coordItems = [];

  if (typeof coords === 'string') {
    // Split by newline, ignore empty lines
    coordItems = coords.split(/\r?\n/).map(s => s.trim()).filter(s => s !== '').map(s => ({ name: '', coordsStr: s }));
  } else if (Array.isArray(coords)) {
    coordItems = coords.map(item => {
      if (typeof item === 'string') {
        return { name: '', coordsStr: item.trim() };
      } else if (typeof item === 'object' && item !== null) {
        // Accept either { name, coords } or { coords } shape
        const coordsStr = item.coords || item.coordsStr || '';
        const name = item.name || item.label || '';
        return { name: String(name).trim(), coordsStr: String(coordsStr).trim() };
      } else {
        return { name: '', coordsStr: '' };
      }
    }).filter(i => i.coordsStr !== '');
  } else {
    throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô string ‡∏´‡∏£‡∏∑‡∏≠ array)');
  }

  if (coordItems.length === 0) {
    throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏à‡∏∏‡∏î');
  }

  radius = Number(radius);
  if (isNaN(radius) || radius <= 0) {
    throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0 (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ï‡∏£)');
  }

  // Validate each coord
  coordItems.forEach(ci => {
    const parts = ci.coordsStr.split(',');
    if (parts.length < 2) {
      throw new Error(`‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: '${ci.coordsStr}' (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "lat,lng")`);
    }
    if (isNaN(Number(parts[0])) || isNaN(Number(parts[1]))) {
      throw new Error(`‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: '${ci.coordsStr}'`);
    }
  });

  // Clear the sheet first (to have predictable layout)
  sheet.clearContents();

  // Write coordinates rows: column A -> name (optional), column B -> coordsStr
  const rows = coordItems.map(ci => [ci.name || '', ci.coordsStr]);
  // Append radius row (no name)
  rows.push(['', radius]);

  sheet.getRange(1, 1, rows.length, 2).setValues(rows);

  return { success: true, message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' };
}

function clearLocationConfig() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(LOCATION_SHEET_NAME);
  if (!sheet) {
    throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ï '${LOCATION_SHEET_NAME}'`);
  }

  sheet.clearContents();
  return { success: true, message: '‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' };
}
// ==============================================================================


// ‚ú® ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 2 ‡∏à‡∏∏‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î (Haversine formula)
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÇ‡∏•‡∏Å ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ï‡∏£
  const phi1 = lat1 * Math.PI / 180;
  const phi2 = lat2 * Math.PI / 180;
  const deltaPhi = (lat2 - lat1) * Math.PI / 180;
  const deltaLambda = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
            Math.cos(phi1) * Math.cos(phi2) *
            Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

  return R * c; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ï‡∏£
}

// ‚ú® ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å: ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
function uploadImageAndSave(formData) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  if (!sheet) throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ï '${SHEET_NAME}'`);

  const folder = DriveApp.getFolderById(FOLDER_ID);
  if (!folder) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Google Drive");

  // --- Logic for Clocking In/Out ---
  if (formData.mode === 'in') {
    if (formData.locationType && formData.locationType.toString().indexOf('‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£') !== -1) {
      try {
        const officeConfig = getOfficeLocationData();
        const userLat = Number(formData.latitude);
        const userLon = Number(formData.longitude);

        if (isNaN(userLat) || isNaN(userLon)) {
          return `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ (‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)`;
        }

        // Check distance to any configured coordinate
        const insideAny = officeConfig.coords.some(c => {
          const dist = calculateDistance(c.lat, c.lon, userLat, userLon);
          return dist <= officeConfig.radius;
        });

        if (!insideAny) {
          // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞ ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
          return `‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ '‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£' ‡πÑ‡∏î‡πâ`;
        }
      } catch (e) {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏≤‡∏ä‡∏µ‡∏ï '‡∏£‡∏±‡∏®‡∏°‡∏µ' ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î
        return `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${e.message}`;
      }
    }
    // üéØ ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏±‡∏®‡∏°‡∏µ

    const data = sheet.getDataRange().getValues();
    const dateStr = Utilities.formatDate(new Date(), "Asia/Bangkok", "yyyy-MM-dd");
    const name = formData.name.trim();
    const rowIndex = data.findIndex(row =>
      String(row[0]).trim() === name &&
      (row[1] ? Utilities.formatDate(new Date(row[1]), "Asia/Bangkok", "yyyy-MM-dd") : '') === dateStr
    );

    if (rowIndex !== -1) {
      return `‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ`;
    }

    // --- Image Upload ---
    try {
      const base64Data = formData.imageBase64.split(',')[1] || formData.imageBase64;
      const blobBytes = Utilities.base64Decode(base64Data);
      const blobFile = Utilities.newBlob(blobBytes, formData.imageType, formData.imageName);
      const file = folder.createFile(blobFile);
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      const fileId = file.getId();
      const lh3Link = `https://lh3.googleusercontent.com/d/${fileId}`;

      // --- Data Preparation & Save ---
      const now = new Date();
      const time = Utilities.formatDate(now, "Asia/Bangkok", "HH:mm:ss");
      
      const newRow = Array(9).fill(''); 
      newRow[0] = name;                 // Column A: Name
      newRow[1] = dateStr;              // Column B: Date
      newRow[2] = time;                 // Column C: Time In
      newRow[4] = formData.latitude;    // Column E: Latitude
      newRow[5] = formData.longitude;   // Column F: Longitude
      newRow[6] = lh3Link;              // Column G: Image In
      newRow[8] = formData.locationType || ''; // Column I: Location Type
      sheet.appendRow(newRow);

      // --- Notify Telegram (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ) ---
      try {
        notifyTelegramOnAttendanceEvent_(name, 'in', time, formData.locationType || '', lh3Link);
      } catch (err) {
        // ‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
        Logger.log('Notify Telegram (in) failed: ' + err.message);
      }

      return `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
    } catch (e) {
      return `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ: ${e.message}`;
    }

  } else { // formData.mode === 'out'
    const data = sheet.getDataRange().getValues();
    const dateStr = Utilities.formatDate(new Date(), "Asia/Bangkok", "yyyy-MM-dd");
    const name = formData.name.trim();
    const rowIndex = data.findIndex(row =>
      String(row[0]).trim() === name &&
      (row[1] ? Utilities.formatDate(new Date(row[1]), "Asia/Bangkok", "yyyy-MM-dd") : '') === dateStr
    );

    if (rowIndex === -1) {
      return `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ`;
    }

    const rowNumber = rowIndex + 1;
    const existingTimeOut = sheet.getRange(rowNumber, 4).getValue();
    if (existingTimeOut) {
      return `‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ`;
    }

    // --- Image Upload ---
    try {
      const base64Data = formData.imageBase64.split(',')[1] || formData.imageBase64;
      const blobBytes = Utilities.base64Decode(base64Data);
      const blobFile = Utilities.newBlob(blobBytes, formData.imageType, formData.imageName);
      const file = folder.createFile(blobFile);
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      const fileId = file.getId();
      const lh3Link = `https://lh3.googleusercontent.com/d/${fileId}`;

      // --- Data Update ---
      const time = Utilities.formatDate(new Date(), "Asia/Bangkok", "HH:mm:ss");
      sheet.getRange(rowNumber, 4).setValue(time);    // Column D: Time Out
      sheet.getRange(rowNumber, 8).setValue(lh3Link); // Column H: Image Out
      sheet.getRange(rowNumber, 5).setValue(formData.latitude); // Update location on clock-out
      sheet.getRange(rowNumber, 6).setValue(formData.longitude);

      // --- Notify Telegram (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ) ---
      try {
        notifyTelegramOnAttendanceEvent_(name, 'out', time, formData.locationType || '', lh3Link);
      } catch (err) {
        Logger.log('Notify Telegram (out) failed: ' + err.message);
      }

      return `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
    } catch (e) {
      return `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ: ${e.message}`;
    }
  }
}

// === ‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ô Google Sheets ===
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å')
    .addItem('üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ', 'showDashboardPage')
    .addItem('‚è∞ ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤', 'showTimeLogPage')
    .addToUi();
}

function showTimeLogPage() {
  const htmlOutput = HtmlService.createHtmlOutputFromFile('index')
    .setTitle("‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô")
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
  SpreadsheetApp.getUi().showSidebar(htmlOutput);
}

function showDashboardPage() {
  const htmlOutput = HtmlService.createHtmlOutputFromFile('dashboard')
    .setTitle("‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô")
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
  SpreadsheetApp.getUi().showSidebar(htmlOutput);
}

// === Admin Code ===
function getAdminCode() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('admin');
  return sheet ? sheet.getRange("A2").getValue().toString().trim() : '';
}

// === ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ===
function getEmployeeNames() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(EMPLOYEE_SHEET_NAME);
    if (!sheet) return [];
    
    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return [];
    
    const names = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
    return names.filter(n => n && n.trim() !== '');
  } catch (e) {
    Logger.log(`Error in getEmployeeNames: ${e}`);
    return [];
  }
}

// === ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ===
function getAttendanceSummaryDaily(dateString) {
  const dataSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const employeeSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(EMPLOYEE_SHEET_NAME);

  if (!dataSheet) throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ï '${SHEET_NAME}'`);
  if (!employeeSheet) throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ï '${EMPLOYEE_SHEET_NAME}'`);

  const allEmployeeNames = getEmployeeNames();
  const logs = dataSheet.getDataRange().getValues();

  const employeeData = {};
  allEmployeeNames.forEach(name => {
    employeeData[name] = {
      name: name,
      timeIn: '',
      timeOut: '',
      locationType: '', 
      imageIn: '',
      imageOut: '',
      status: '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤'
    };
  });

  for (let i = 1; i < logs.length; i++) {
    const row = logs[i];
    const name = String(row[0]).trim();
    const logDate = row[1] ? Utilities.formatDate(new Date(row[1]), "Asia/Bangkok", "yyyy-MM-dd") : '';

    if (logDate === dateString && employeeData[name]) {
      employeeData[name].timeIn = row[2] ? Utilities.formatDate(new Date(row[2]), "Asia/Bangkok", "HH:mm") : '';
      employeeData[name].timeOut = row[3] ? Utilities.formatDate(new Date(row[3]), "Asia/Bangkok", "HH:mm") : '';
      employeeData[name].imageIn = row[6] || '';
      employeeData[name].imageOut = row[7] || '';
      employeeData[name].locationType = row[8] || '';
    }
  }

  const summary = {
    totalEmployees: allEmployeeNames.length,
    loggedOut: 0,
    notLoggedOut: 0,
    missing: 0
  };

  const details = Object.values(employeeData).map(emp => {
    if (emp.timeIn && emp.timeOut) {
      emp.status = '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
      summary.loggedOut++;
    } else if (emp.timeIn) {
      emp.status = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô';
      summary.notLoggedOut++;
    } else {
      emp.status = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤';
      summary.missing++;
    }
    return emp;
  });

  return { summary, details };
}

// === ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ===
function getIndividualAttendanceData(employeeName, startDate, endDate) {
  if (!employeeName || !startDate || !endDate) {
    throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
  }

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  if (!sheet) throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ï '${SHEET_NAME}'`);

  const data = sheet.getDataRange().getValues();
  const results = [];
  
  const start = new Date(startDate);
  start.setHours(0, 0, 0, 0);
  const end = new Date(endDate);
  end.setHours(23, 59, 59, 999);

  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const name = String(row[0]).trim();
    
    if (name === employeeName) {
      if (!row[1]) continue;
      const logDate = new Date(row[1]);

      if (logDate >= start && logDate <= end) {
        const timeIn = row[2] ? Utilities.formatDate(new Date(row[2]), "Asia/Bangkok", "HH:mm") : '';
        const timeOut = row[3] ? Utilities.formatDate(new Date(row[3]), "Asia/Bangkok", "HH:mm") : '';
        
        let status = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤';
        if (timeIn && timeOut) {
          status = '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
        } else if (timeIn) {
          status = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô';
        }

        results.push({
          date: Utilities.formatDate(logDate, "Asia/Bangkok", "d MMM yyyy"),
          timeIn: timeIn,
          timeOut: timeOut,
          locationType: row[8] || '-',
          status: status
        });
      }
    }
  }

  results.sort((a, b) => new Date(b.date) - new Date(a.date));
  return results;
}

// === ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ===
function addEmployee(name) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(EMPLOYEE_SHEET_NAME);
    if (!sheet) {
      throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ï‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠ '${EMPLOYEE_SHEET_NAME}'`);
    }

    const existingNames = sheet.getRange("A1:A").getValues().flat().filter(String);
    if (existingNames.includes(name)) {
      throw new Error(`‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠ '${name}' ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß`);
    }

    sheet.appendRow([name]);
    return { success: true, message: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏ì ${name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à` };

  } catch (e) {
    console.error(`Add Employee Error: ${e.message}`);
    throw new Error(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${e.message}`);
  }
}

// === ‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ===
function deleteEmployee(nameToDelete) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(EMPLOYEE_SHEET_NAME);
    if (!sheet) {
      throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ï‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠ '${EMPLOYEE_SHEET_NAME}'`);
    }
    
    const namesRange = sheet.getRange("A1:A");
    const names = namesRange.getValues().flat();
    
    const rowIndexToDelete = names.findIndex(name => name === nameToDelete);

    if (rowIndexToDelete !== -1) {
      sheet.deleteRow(rowIndexToDelete + 1);
      return { success: true, message: `‡∏•‡∏ö‡∏Ñ‡∏∏‡∏ì ${nameToDelete} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à` };
    } else {
      throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠ '${nameToDelete}' ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`);
    }

  } catch (e) {
    console.error(`Delete Employee Error: ${e.message}`);
    throw new Error(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${e.message}`);
  }
}