const TELEGRAM_TOKEN   = '8123752664:AAERH_1aPOQGgruanOW_jbevyM8zN4i45JI';  // ‡πÉ‡∏™‡πà‡πÇ‡∏ó‡πÄ‡∏Ñ‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const TELEGRAM_CHAT_ID = '-5090490925';                                      // ‡πÉ‡∏™‡πà chatId ‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á/‡∏Å‡∏•‡∏∏‡πà‡∏°
const TG_MAX_LEN = 4096; // ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á Telegram

/** =====================[ CORE ]===================== */
/** ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å Telegram ‡πÇ‡∏î‡∏¢‡∏°‡∏µ fallback ‡∏°‡∏≤‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
function readTelegramConfig_() {
  const sp = PropertiesService.getScriptProperties();
  const token = sp.getProperty('TELEGRAM_TOKEN') || TELEGRAM_TOKEN;
  const chatId = sp.getProperty('TELEGRAM_CHAT_ID') || TELEGRAM_CHAT_ID;
  if (!token || !chatId) {
    throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Telegram token/chat id (Script Properties ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà)');
  }
  return { token, chatId };
}

/** escape ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö parse_mode: 'HTML' */
function esc_(s) {
  if (s == null) return '';
  return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

/** ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ Telegram (auto split ‡∏ñ‡πâ‡∏≤‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 4096) */
function tgSendText_(text, parseMode) {
  const { token, chatId } = readTelegramConfig_();
  const url = 'https://api.telegram.org/bot' + token + '/sendMessage';
  const mode = parseMode || 'HTML';

  const chunks = splitTextByLimit_(text, TG_MAX_LEN);
  chunks.forEach(chunk => {
    const payload = {
      chat_id: chatId,
      text: chunk,
      parse_mode: mode,
      disable_web_page_preview: true
    };
    const params = { method: 'post', payload, muteHttpExceptions: true };
    UrlFetchApp.fetch(url, params);
  });
}

/** ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏õ Telegram ‡∏û‡∏£‡πâ‡∏≠‡∏° caption */
function tgSendPhoto_(photoUrl, caption) {
  const { token, chatId } = readTelegramConfig_();
  const url = 'https://api.telegram.org/bot' + token + '/sendPhoto';
  const payload = {
    chat_id: chatId,
    photo: photoUrl,
    caption: caption || '',
    parse_mode: 'HTML'
  };
  const params = { method: 'post', payload, muteHttpExceptions: true };
  UrlFetchApp.fetch(url, params);
}

/** ‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏•‡∏¥‡∏°‡∏¥‡∏ï */
function splitTextByLimit_(text, limit) {
  const out = [];
  let i = 0;
  while (i < text.length) {
    out.push(text.substring(i, i + limit));
    i += limit;
  }
  return out;
}

/** =====================[ Utilities ]===================== */
/** ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢: 20 ‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏° 2568
 * ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 'yyyy-MM-dd' ‡∏´‡∏£‡∏∑‡∏≠ Date object
 */
function formatThaiDateLongBE_(dateInput) {
  let d;
  if (typeof dateInput === 'string') {
    const parts = dateInput.split('-'); // ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á 'yyyy-MM-dd'
    if (parts.length === 3) {
      d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
    } else {
      d = new Date(dateInput);
    }
  } else {
    d = new Date(dateInput);
  }

  const months = [
    '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
    '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
  ];
  const day   = d.getDate();
  const month = months[d.getMonth()];
  const yearBE = d.getFullYear() + 543;

  return `${day} ${month} ${yearBE}`;
}

/** padding ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô <pre> ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô */
function pad_(s, n) {
  s = (s == null ? '' : String(s));
  if (s.length > n) return s.slice(0, n - 1) + '‚Ä¶';
  return s + ' '.repeat(n - s.length);
}

/** ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÅ‡∏ö‡∏ö‡∏õ‡∏±‡∏î‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô (1 ‡∏à‡∏∏‡∏î‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°) */
function pct_(part, total) {
  if (!total) return '0%';
  return Math.round((part * 1000) / total) / 10 + '%';
}

/** ‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏±‡πà‡∏ô */
function line_() {
  return '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ';
}

/** =====================[ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á/‡∏Å‡∏•‡∏∏‡πà‡∏° ]===================== */
/** ‡∏™‡∏£‡πâ‡∏≤‡∏á ‚Äú‡∏ï‡∏≤‡∏£‡∏≤‡∏á‚Äù ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‚Äì‡∏≠‡∏≠‡∏Å */
function buildDoneTable_(rows) {
  // ‡∏ä‡∏∑‡πà‡∏≠(20) | ‡πÄ‡∏Ç‡πâ‡∏≤(5) | ‡∏≠‡∏≠‡∏Å(5) | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà(20)
  const header = '‡∏ä‡∏∑‡πà‡∏≠' + ' '.repeat(17) + '‡πÄ‡∏Ç‡πâ‡∏≤   ‡∏≠‡∏≠‡∏Å   ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà';
  const lines = [header];
  rows.forEach(e => {
    const name = pad_(e.name, 20);
    const tIn  = pad_(e.timeIn || '-', 5);
    const tOut = pad_(e.timeOut || '-', 5);
    const loc  = pad_(e.location || '-', 20);
    lines.push(`${name} ${tIn}  ${tOut}  ${loc}`);
  });
  return '<pre>' + lines.join('\n') + '</pre>';
}

/** ‡∏™‡∏£‡πâ‡∏≤‡∏á ‚Äú‡∏ï‡∏≤‡∏£‡∏≤‡∏á‚Äù ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å (‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ | ‡πÄ‡∏Ç‡πâ‡∏≤ | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà) */
function buildNotOutTable_(rows) {
  const header = '‡∏ä‡∏∑‡πà‡∏≠' + ' '.repeat(17) + '‡πÄ‡∏Ç‡πâ‡∏≤   ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà';
  const lines = [header];
  rows.forEach(e => {
    const name = pad_(e.name, 20);
    const tIn  = pad_((e.timeIn || '-'), 5);
    const loc  = pad_(e.location || '-', 20);
    lines.push(`${name} ${tIn}  ${loc}`);
  });
  return '<pre>' + lines.join('\n') + '</pre>';
}

/** ‡∏™‡∏£‡πâ‡∏≤‡∏á ‚Äú‡∏ï‡∏≤‡∏£‡∏≤‡∏á‚Äù ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) */
function buildMissingTable_(rows) {
  const header = '‡∏ä‡∏∑‡πà‡∏≠';
  const lines = [header];
  rows.forEach(e => lines.push(`‚Ä¢ ${e.name}`));
  return lines.join('\n');
}

/** ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö ‚Äú‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ + ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‚Äù (‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢) */
function tgSendSection_(title, body) {
  const msg = `<b>${title}</b>\n${body}`;
  tgSendText_(msg, 'HTML');
}

/** =====================[ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô + BE) ]===================== */
/**
 * options:
 *  {
 *    includeDetails: true (default) ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏°
 *    splitByGroup: false (default) ‚Äî true ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: Header 1 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° + ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏∞ 1 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
 *    showDone: true, showNotOut: true, showMissing: true ‚Äî ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°
 *  }
 */
function buildDailyAttendanceReportClear_(dateString, options) {
  const opt = Object.assign({
    includeDetails: true,
    splitByGroup: false,
    showDone: true,
    showNotOut: true,
    showMissing: true
  }, options || {});

  if (typeof getAttendanceSummaryDaily !== 'function') {
    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getAttendanceSummaryDaily(dateString) ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå');
  }

  const { summary, details } = getAttendanceSummaryDaily(dateString);

  // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà "20 ‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏° 2568"
  const thDate = formatThaiDateLongBE_(dateString);

  // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
  const done = [];
  const notOut = [];
  const missing = [];
  details.forEach(emp => {
    if (emp.status === '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß') {
      done.push(emp);
    } else if (emp.status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô') {
      notOut.push(emp);
    } else {
      missing.push(emp);
    }
  });

  // ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß + KPI
  const header = [
    `<b>üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‚Äî ${esc_(thDate)}</b>`,
    `üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b>${summary.totalEmployees}</b>`,
    `‚úÖ ‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß: <b>${summary.loggedOut}</b> (${pct_(summary.loggedOut, summary.totalEmployees)})`,
    `üïí ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô: <b>${summary.notLoggedOut}</b> (${pct_(summary.notLoggedOut, summary.totalEmployees)})`,
    `‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤: <b>${summary.missing}</b> (${pct_(summary.missing, summary.totalEmployees)})`,
  ].join('\n');

  if (!opt.includeDetails) {
    // ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏•‡πâ‡∏ß‡∏ô
    return header;
  }

  // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (default)
  if (!opt.splitByGroup) {
    const parts = [header, ''];
    if (opt.showDone && done.length) {
      parts.push(`<b>‚úÖ ‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß (${done.length})</b>`);
      parts.push(buildDoneTable_(done));
      parts.push('');
    }
    if (opt.showNotOut && notOut.length) {
      parts.push(`<b>üïí ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (${notOut.length})</b>`);
      parts.push(buildNotOutTable_(notOut));
      parts.push('');
    }
    if (opt.showMissing && missing.length) {
      parts.push(`<b>‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (${missing.length})</b>`);
      parts.push(buildMissingTable_(missing));
      parts.push('');
    }
    return parts.join('\n');
  }

  // ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° (header ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° + ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏∞‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)
  return {
    header,
    sections: [
      opt.showDone && done.length ? { title: `‚úÖ ‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß (${done.length})`, body: buildDoneTable_(done) } : null,
      opt.showNotOut && notOut.length ? { title: `üïí ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (${notOut.length})`, body: buildNotOutTable_(notOut) } : null,
      opt.showMissing && missing.length ? { title: `‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (${missing.length})`, body: buildMissingTable_(missing) } : null
    ].filter(Boolean)
  };
}

/** =====================[ ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ/‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô ]===================== */

/** ‡∏™‡πà‡∏á ‚Äú‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‚Äù (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô + BE) */
function sendDailyAttendanceReportToTelegramClear(options) {
  const today = Utilities.formatDate(new Date(), "Asia/Bangkok", "yyyy-MM-dd");
  const msg = buildDailyAttendanceReportClear_(today, options);
  if (typeof msg === 'string') {
    tgSendText_(msg, 'HTML');
  } else {
    tgSendText_(msg.header, 'HTML');
    msg.sections.forEach(sec => tgSendSection_(sec.title, sec.body));
  }
}

/** ‡∏™‡πà‡∏á ‚Äú‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô‚Äù (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô + BE) */
function sendYesterdayAttendanceReportToTelegramClear(options) {
  const now = new Date();
  const y = new Date(now.getTime() - 24 * 60 * 60 * 1000);
  const dateStr = Utilities.formatDate(y, "Asia/Bangkok", "yyyy-MM-dd");
  const msg = buildDailyAttendanceReportClear_(dateStr, options);
  if (typeof msg === 'string') {
    tgSendText_(msg, 'HTML');
  } else {
    tgSendText_(msg.header, 'HTML');
    msg.sections.forEach(sec => tgSendSection_(sec.title, sec.body));
  }
}

/** =====================[ Trigger ‡∏™‡πà‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ]===================== */

function deleteTriggersByHandler_(handlerFunctionName) {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(t => {
    if (t.getHandlerFunction() === handlerFunctionName) {
      ScriptApp.deleteTrigger(t);
    }
  });
}

/** ‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ ‚Äú‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‚Äù ‡πÄ‡∏ß‡∏•‡∏≤ 17:30 ‡∏ô. ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô */
function createDailyReportTrigger_17_30_Clear() {
  deleteTriggersByHandler_('sendDailyAttendanceReportToTelegramClear');
  ScriptApp.newTrigger('sendDailyAttendanceReportToTelegramClear')
    .timeBased()
    .atHour(17)
    .nearMinute(30)
    .everyDays(1)
    .create();
}

/** ‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ ‚Äú‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô‚Äù ‡πÄ‡∏ß‡∏•‡∏≤ 08:30 ‡∏ô. ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô */
function createMorningYesterdayReportTrigger_08_30_Clear() {
  deleteTriggersByHandler_('sendYesterdayAttendanceReportToTelegramClear');
  ScriptApp.newTrigger('sendYesterdayAttendanceReportToTelegramClear')
    .timeBased()
    .atHour(8)
    .nearMinute(30)
    .everyDays(1)
    .create();
}

function notifyTelegramOnAttendanceEvent_(name, mode, timeHHmmss, locationText, photoUrl) {
  const actionEmoji = (mode === 'in') ? 'üü¢' : 'üîµ';
  const actionText  = (mode === 'in') ? '‡πÄ‡∏ä‡πá‡∏Å‡∏≠‡∏¥‡∏ô' : '‡πÄ‡∏ä‡πá‡∏Å‡πÄ‡∏≠‡∏≤‡∏ï‡πå';

  // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô "20 ‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏° 2568"
  const todayTH = formatThaiDateLongBE_(new Date());

  const caption =
    `<b>${actionEmoji} ${actionText}</b>\n` +
    `‡∏ä‡∏∑‡πà‡∏≠: <b>${esc_(name)}</b>\n` +
    `‡πÄ‡∏ß‡∏•‡∏≤: <b>${esc_(timeHHmmss)}</b>\n` +
    `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${esc_(todayTH)}\n` +
    (locationText ? `‡∏à‡∏∏‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${esc_(locationText)}` : '');

  try {
    if (photoUrl) {
      tgSendPhoto_(photoUrl, caption);
    } else {
      tgSendText_(caption, 'HTML');
    }
  } catch (err) {
    tgSendText_(caption + '\n(‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)', 'HTML');
  }
}
